
<div class="p-6">

    <p-toast></p-toast>
    <p-confirmDialog [style]="{width: '450px'}"></p-confirmDialog>

    <app-data-table
        [title]="'dashboard.controlPanel.pests.title' | translate"
        [data]="pests()"
        [cols]="cols"
        [loading]="loading()"
        [serverPagination]="true"
        [totalRecords]="totalRecords()"
        tableId="pests-table"
        [showAddButton]="true"
        [showEditButton]="true"
        [showDeleteButton]="true"
        [addPermission]="AppPermissions.Pest.Create"
        [editPermission]="AppPermissions.Pest.Edit"
        [deletePermission]="AppPermissions.Pest.Delete"
        (pageChange)="onPageChange($event)"
        (add)="onAdd()"
        (edit)="onEdit($event)"
        (delete)="onDelete($event)">
    </app-data-table>

    <p-dialog
        [(visible)]="displayDialog"
        [style]="{ width: '52rem' }"
        [breakpoints]="{ '960px': '92vw', '640px': '96vw' }"
        [modal]="true"
        [draggable]="false"
        [resizable]="false"
        styleClass="pests-dialog p-fluid">
        <ng-template pTemplate="header">
            <div class="flex items-start gap-3">
                <div class="w-10 h-10 rounded-xl bg-amber-50 text-amber-700 flex items-center justify-center">
                    <i class="pi pi-exclamation-triangle"></i>
                </div>
                <div class="min-w-0">
                    <div class="text-base font-bold text-slate-800">
                        {{ (selectedPest.id ? 'common.edit' : 'common.add') | translate }}
                    </div>
                    <div class="text-sm text-slate-500">
                        {{ 'dashboard.controlPanel.pests.title' | translate }}
                    </div>
                </div>
            </div>
        </ng-template>
        <ng-template pTemplate="content">
            <div class="space-y-4">
                <app-dynamic-form
                    [config]="formConfig()"
                    [initialData]="selectedPest"
                    [submitLabel]="'common.save'"
                    [cancelLabel]="'common.cancel'"
                    [loading]="saving()"
                    (formSubmit)="savePest($event)"
                    (formCancel)="hideDialog()">
                </app-dynamic-form>

                @if (selectedPest.id) {
                    <div class="bg-white rounded-xl border border-slate-100 p-4">
                        <div class="flex items-center justify-between mb-3">
                            <div class="font-bold text-slate-800">
                                {{ 'dashboard.controlPanel.pests.pesticides' | translate }}
                            </div>
                            <div class="text-xs text-slate-500">
                                {{ pestPesticides().length }}
                            </div>
                        </div>

                        <div class="grid grid-cols-12 gap-3 items-end">
                            <div class="col-span-12 md:col-span-7">
                                <div class="block text-sm font-medium text-slate-700 mb-1">
                                    {{ 'dashboard.controlPanel.inventory.pesticide' | translate }}
                                </div>
                                <p-select
                                    [options]="pesticideOptions()"
                                    optionLabel="label"
                                    optionValue="value"
                                    [(ngModel)]="newPesticideId"
                                    styleClass="w-full">
                                </p-select>
                            </div>

                            <div class="col-span-12 md:col-span-3">
                                <div class="block text-sm font-medium text-slate-700 mb-1">
                                    {{ 'dashboard.controlPanel.pesticides.dilutionRate' | translate }}
                                </div>
                                <p-inputNumber [(ngModel)]="newDilutionRate" styleClass="w-full"></p-inputNumber>
                            </div>

                            <div class="col-span-12 md:col-span-2">
                                <button
                                    pButton
                                    type="button"
                                    icon="pi pi-plus"
                                    [label]="'common.add' | translate"
                                    class="w-full"
                                    *appHasPermission="AppPermissions.Pest.Edit"
                                    [disabled]="pesticidesSaving() || newPesticideId === null || newPesticideId === undefined || newDilutionRate === null || newDilutionRate === undefined"
                                    (click)="addPesticideToPest()">
                                </button>
                            </div>
                        </div>

                        @if (pestPesticides().length > 0) {
                            <div class="mt-4 overflow-hidden rounded-lg border border-slate-100">
                                <div class="grid grid-cols-12 bg-slate-50 text-xs font-bold text-slate-600 px-3 py-2">
                                    <div class="col-span-7">{{ 'dashboard.controlPanel.inventory.pesticide' | translate }}</div>
                                    <div class="col-span-3">{{ 'dashboard.controlPanel.pesticides.dilutionRate' | translate }}</div>
                                    <div class="col-span-2 text-center">{{ 'common.actions' | translate }}</div>
                                </div>
                                <div class="divide-y divide-slate-100">
                                    @for (pp of pestPesticides(); track pp.pesticideId) {
                                        <div class="grid grid-cols-12 items-center px-3 py-2 bg-white">
                                            <div class="col-span-7 text-sm text-slate-700 truncate">
                                                {{ pp.pesticideName }}
                                            </div>
                                            <div class="col-span-3">
                                                <p-inputNumber [(ngModel)]="pp.dilutionRate" styleClass="w-full"></p-inputNumber>
                                            </div>
                                            <div class="col-span-2 flex items-center justify-center gap-2">
                                                <button
                                                    pButton
                                                    type="button"
                                                    icon="pi pi-save"
                                                    class="p-button-text p-button-rounded p-button-sm"
                                                    *appHasPermission="AppPermissions.Pest.Edit"
                                                    [disabled]="pesticidesSaving()"
                                                    (click)="saveDilutionRate(pp)">
                                                </button>
                                                <button
                                                    pButton
                                                    type="button"
                                                    icon="pi pi-trash"
                                                    class="p-button-text p-button-rounded p-button-sm p-button-danger"
                                                    *appHasPermission="AppPermissions.Pest.Edit"
                                                    [disabled]="pesticidesSaving()"
                                                    (click)="removePesticide(pp)">
                                                </button>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        } @else {
                            <div class="mt-4 p-4 rounded-xl bg-slate-50 border border-slate-200 text-sm text-slate-600">
                                {{ 'dashboard.controlPanel.pests.noPesticides' | translate }}
                            </div>
                        }
                    </div>

                    <div class="bg-white rounded-xl border border-slate-100 p-4">
                        <div class="flex items-center justify-between mb-3">
                            <div class="font-bold text-slate-800">
                                {{ 'dashboard.controlPanel.pests.children' | translate }}
                            </div>
                            <div class="text-xs text-slate-500">
                                {{ pestChildren().length }}
                            </div>
                        </div>

                        @if (pestChildren().length > 0) {
                            <div class="flex flex-wrap gap-2">
                                @for (child of pestChildren(); track child.id) {
                                    <span class="px-3 py-1 rounded-full bg-slate-100 text-slate-700 text-xs font-medium">
                                        {{ child.name }}
                                    </span>
                                }
                            </div>
                        } @else {
                            <div class="p-4 rounded-xl bg-slate-50 border border-slate-200 text-sm text-slate-600">
                                {{ 'common.noData' | translate }}
                            </div>
                        }
                    </div>
                }
            </div>
        </ng-template>
    </p-dialog>
</div>
