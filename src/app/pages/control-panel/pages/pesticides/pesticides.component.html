<div class="p-6">
    <p-toast></p-toast>
    <p-confirmDialog [style]="{ width: '28rem' }" styleClass="confirm-danger"></p-confirmDialog>

    <app-data-table
        [title]="'dashboard.controlPanel.pesticides.title' | translate"
        [data]="pesticides()"
        [cols]="cols"
        [loading]="loading()"
        [serverPagination]="true"
        [totalRecords]="totalRecords()"
        tableId="pesticides-table"
        [showAddButton]="true"
        [showEditButton]="true"
        [showDeleteButton]="true"
        [addPermission]="AppPermissions.Pesticide.Create"
        [editPermission]="AppPermissions.Pesticide.Edit"
        [deletePermission]="AppPermissions.Pesticide.Delete"
        (pageChange)="onPageChange($event)"
        (add)="onAdd()"
        (edit)="onEdit($event)"
        (delete)="onDelete($event)">
    </app-data-table>

    <p-dialog
        [(visible)]="displayDialog"
        [style]="{ width: '52rem' }"
        [breakpoints]="{ '960px': '92vw', '640px': '96vw' }"
        [modal]="true"
        [draggable]="false"
        [resizable]="false"
        styleClass="pesticide-dialog p-fluid">
        <ng-template pTemplate="header">
            <div class="flex items-start gap-3">
                <div class="w-10 h-10 rounded-xl bg-emerald-50 text-emerald-700 flex items-center justify-center">
                    <i class="pi pi-filter-fill"></i>
                </div>
                <div class="min-w-0">
                    <div class="text-base font-bold text-slate-800">
                        {{ (selectedPesticide.id ? 'common.edit' : 'common.add') | translate }}
                    </div>
                    <div class="text-sm text-slate-500">
                        {{ 'dashboard.controlPanel.pesticides.title' | translate }}
                    </div>
                </div>
            </div>
        </ng-template>
        <ng-template pTemplate="content">
            <div class="space-y-4">
                <div class="bg-white rounded-xl border border-slate-100 p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="font-bold text-slate-800">
                            {{ 'dashboard.controlPanel.pesticides.targetPests' | translate }}
                        </div>
                        <div class="text-xs text-slate-500">
                            {{ targetedPests().length }}
                        </div>
                    </div>

                    <div class="grid grid-cols-12 gap-3 items-end">
                        <div class="col-span-12 md:col-span-7">
                            <div class="block text-sm font-medium text-slate-700 mb-1">
                                {{ 'dashboard.controlPanel.pesticides.pest' | translate }}
                            </div>
                            <p-select
                                [options]="pestOptions()"
                                optionLabel="label"
                                optionValue="value"
                                [(ngModel)]="newTargetPestId"
                                styleClass="w-full">
                            </p-select>
                        </div>

                        <div class="col-span-12 md:col-span-3">
                            <div class="block text-sm font-medium text-slate-700 mb-1">
                                {{ 'dashboard.controlPanel.pesticides.dilutionRate' | translate }}
                            </div>
                            <p-inputNumber [(ngModel)]="newTargetDilutionRate" styleClass="w-full"></p-inputNumber>
                        </div>

                        <div class="col-span-12 md:col-span-2">
                            <button
                                pButton
                                type="button"
                                icon="pi pi-plus"
                                [label]="'common.add' | translate"
                                class="w-full"
                                [disabled]="newTargetPestId === null || newTargetPestId === undefined || newTargetDilutionRate === null || newTargetDilutionRate === undefined"
                                (click)="addTargetPest()">
                            </button>
                        </div>
                    </div>

                    @if (targetedPests().length > 0) {
                        <div class="mt-4 overflow-hidden rounded-lg border border-slate-100">
                            <div class="grid grid-cols-12 bg-slate-50 text-xs font-bold text-slate-600 px-3 py-2">
                                <div class="col-span-7">{{ 'dashboard.controlPanel.pesticides.pest' | translate }}</div>
                                <div class="col-span-3">{{ 'dashboard.controlPanel.pesticides.dilutionRate' | translate }}</div>
                                <div class="col-span-2 text-center">{{ 'dashboard.operations' | translate }}</div>
                            </div>
                            <div class="divide-y divide-slate-100">
                                @for (tp of targetedPests(); track tp.pestId) {
                                    <div class="grid grid-cols-12 items-center px-3 py-2 bg-white">
                                        <div class="col-span-7 text-sm text-slate-700 truncate">
                                            {{ tp.pestName || tp.pestId }}
                                        </div>
                                        <div class="col-span-3">
                                            <p-inputNumber
                                                [ngModel]="tp.dilutionRate"
                                                (ngModelChange)="onTargetDilutionChange(tp.pestId, $event)"
                                                styleClass="w-full">
                                            </p-inputNumber>
                                        </div>
                                        <div class="col-span-2 flex justify-center">
                                            <button
                                                pButton
                                                type="button"
                                                icon="pi pi-trash"
                                                class="p-button-danger p-button-text"
                                                (click)="removeTargetPest(tp.pestId)">
                                                <span class="sr-only">{{ 'common.delete' | translate }}</span>
                                            </button>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    } @else {
                        <div class="mt-4 text-sm text-slate-500 bg-slate-50 rounded-lg p-3 border border-dashed border-slate-200">
                            {{ 'common.noData' | translate }}
                        </div>
                    }
                </div>

                <div class="bg-white rounded-xl border border-slate-100 p-4">
                    <app-dynamic-form
                        [config]="formConfig()"
                        [initialData]="selectedPesticide"
                        [submitLabel]="'common.save'"
                        [cancelLabel]="'common.cancel'"
                        [loading]="saving()"
                        (formSubmit)="savePesticide($event)"
                        (formCancel)="hideDialog()">
                    </app-dynamic-form>
                </div>
            </div>
        </ng-template>
    </p-dialog>
</div>
